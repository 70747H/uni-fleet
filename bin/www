const app = require('../src/app')
const { Server } = require('socket.io')
const http = require('http')
const workOrderPointsService = require('../src/app/work-order/work-order-points/work-order-points.service')

function normalizePort (port) {
  if (typeof port === 'string') return +port
}

const port = normalizePort(process.env.NODE_PORT || '3000')
app.set('port', port)
const httpServer = http.createServer(app)

const io = new Server(httpServer)

io.on('connection', (socket) => {
  socket.on('vehicle1:location:update', async (data) => {
    const result = await workOrderPointsService.isNearWorkOrderPoints([data.long, data.lat])
    if (result.length) console.log(`You're ${result[0].distance} away from the nearest point`)
    else console.log('You\'re not followin the check-points')
  })
})

httpServer.listen(port, () => {
  console.log(`listening on *:${port}`)
})
